<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="google-site-verification" content="CChSth3PKkqvJ6-owYPkVrilKVZbD5h8KHE8Ei3timo" />
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Delta Air Lines SkyMiles loyalty program - Book flights, earn miles, and enjoy exclusive benefits"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>Delta SkyMiles - Fly the World with Delta</title>
  </head>
  <body>
    <script type="text/javascript">
    // Load Data Cloud SDK first, then embedded messaging (following working pattern)
    function loadDataCloudSDK() {
      return new Promise((resolve, reject) => {
        console.log('üåê Loading Data Cloud SDK script...');
        const script = document.createElement('script');
        script.src = 'https://cdn.c360a.salesforce.com/beacon/c360a/6b13de41-2e5c-4e5d-bd23-fa67b0bf66a4/scripts/c360a.min.js';
        script.async = true;
        script.defer = true;
        
        script.onload = () => {
          console.log('‚úÖ Data Cloud SDK script loaded');
          resolve();
        };
        
        script.onerror = () => {
          console.error('‚ùå Failed to load Data Cloud SDK script');
          reject(new Error('Failed to load Data Cloud SDK script'));
        };
        
        document.head.appendChild(script);
      });
    }
    
    function checkForSalesforceInteractions() {
      return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
          if (window.SalesforceInteractions && typeof window.SalesforceInteractions.getAnonymousId === 'function') {
            console.log('üåê SalesforceInteractions found and ready with getAnonymousId');
            clearInterval(checkInterval);
            resolve();
          } else {
            console.log('‚è≥ SalesforceInteractions not yet available. Checking again in 500ms...');
          }
        }, 500);
      });
    }
    
    function initEmbeddedMessaging() {
      try {
        console.log('ü§ñ Initializing embedded messaging...');
        embeddedservice_bootstrap.settings.language = 'en_US';
        
        embeddedservice_bootstrap.init(
          '00Dao00000Yz1Wx',
          'Agent_Web_Deployment',
          'https://deltaloyalty-demo.my.site.com/ESWAgentWebDeployment1749608334404',
          { scrt2URL: 'https://deltaloyalty-demo.my.salesforce-scrt.com' }
        );
        
        // Wait for prechat API to be ready and set device ID
        const checkPrechatAPIReady = () => {
          if (window.embeddedservice_bootstrap?.prechatAPI?.setHiddenPrechatFields) {
            console.log('‚úÖ Prechat API is ready, now checking SalesforceInteractions initialization...');
            
            // First, ensure SalesforceInteractions is properly initialized
            const initializeSalesforceSDK = () => {
              try {
                console.log('üîß Initializing SalesforceInteractions SDK...');
                
                // Check if SalesforceInteractions has an init method
                if (typeof window.SalesforceInteractions.init === 'function') {
                  console.log('üìã Calling SalesforceInteractions.init()...');
                  window.SalesforceInteractions.init({
                    cookieDomain: window.location.hostname,
                    consent: true,
                    debug: true
                  });
                }
                
                // Wait for SDK to generate device ID
                let attempts = 0;
                const maxAttempts = 50;
                const checkDeviceId = () => {
                  attempts++;
                  const deviceId = window.SalesforceInteractions.getAnonymousId();
                  
                  console.log(`üîç Attempt ${attempts}: Checking device ID:`, {
                    deviceId: deviceId,
                    type: typeof deviceId,
                    length: deviceId ? deviceId.length : 0,
                    isEmpty: !deviceId || deviceId === '',
                    hasInit: typeof window.SalesforceInteractions.init === 'function'
                  });
                  
                  if (deviceId && deviceId !== '') {
                    console.log('‚úÖ Real device ID obtained from SalesforceInteractions:', deviceId);
                    
                    // Set the device ID in prechat
                    const prechatData = {
                      deviceId: deviceId,
                    };
                    
                    console.log('üì° Setting prechat fields:', prechatData);
                    window.embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields(prechatData);
                    
                    console.log('‚úÖ Device ID successfully configured for prechat!');
                    console.log('ü§ñ Prechat API call completed successfully with deviceId:', deviceId);
                    
                    // Dispatch event with real device ID
                    window.dispatchEvent(new CustomEvent('salesforceInteractionsReady', { 
                      detail: { realSDK: true, deviceId: deviceId } 
                    }));
                    
                    console.log('üéâ SalesforceInteractions initialization sequence completed!');
                    
                    // Add debugging for agent conversation to see what device ID is being used
                    window.addEventListener('onEmbeddedMessageSent', (event) => {
                      console.log('üîç Agent message event - checking for device ID:', JSON.stringify(event.detail, null, 2));
                      // Look for device IDs in the event
                      const eventStr = JSON.stringify(event.detail);
                      if (eventStr.includes('0PAao000006NG73GAG') || eventStr.includes('0PAao000006NH9ZGAW')) {
                        console.log('üö® FOUND PROBLEMATIC DEVICE ID IN AGENT EVENT!');
                      }
                    });
                    
                    window.addEventListener('onConversationEntryLogged', (event) => {
                      console.log('üîç Conversation entry logged - checking for device ID:', JSON.stringify(event.detail, null, 2));
                      // Look for device IDs in the event
                      const eventStr = JSON.stringify(event.detail);
                      if (eventStr.includes('0PAao000006NG73GAG') || eventStr.includes('0PAao000006NH9ZGAW')) {
                        console.log('üö® FOUND PROBLEMATIC DEVICE ID IN CONVERSATION LOG!');
                      }
                    });
                    return;
                  }
                  
                  if (attempts >= maxAttempts) {
                    console.log('‚ö†Ô∏è Max attempts reached, generating fallback device ID...');
                    const fallbackDeviceId = 'sf-timeout-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    
                    window.embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
                      deviceId: fallbackDeviceId,
                    });
                    
                    window.dispatchEvent(new CustomEvent('salesforceInteractionsReady', { 
                      detail: { realSDK: false, deviceId: fallbackDeviceId } 
                    }));
                    
                    console.log('üéâ SalesforceInteractions initialization completed with fallback ID:', fallbackDeviceId);
                    return;
                  }
                  
                  // Wait and try again
                  setTimeout(checkDeviceId, 200);
                };
                
                // Start checking for device ID
                checkDeviceId();
                
              } catch (e) {
                console.error('‚ùå Error initializing SalesforceInteractions:', e);
                
                // Generate error fallback
                const errorDeviceId = 'error-generated-' + Date.now();
                window.embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
                  deviceId: errorDeviceId,
                });
                
                window.dispatchEvent(new CustomEvent('salesforceInteractionsReady', { 
                  detail: { realSDK: false, deviceId: errorDeviceId } 
                }));
              }
            };
            
            // Initialize the SDK
            initializeSalesforceSDK();
            
          } else {
            console.log('‚è≥ Prechat API not yet available. Checking again in 500ms...');
            setTimeout(checkPrechatAPIReady, 500);
          }
        };
        
        console.log('ü§ñ Waiting for prechat API to become available...');
        checkPrechatAPIReady();
        
      } catch (err) {
        console.error('‚ùå Error loading Embedded Messaging:', err);
      }
    }
    
    function loadEmbeddedMessagingScript() {
      console.log('ü§ñ SalesforceInteractions ready. Loading embedded messaging script...');
      const script = document.createElement('script');
      script.src = 'https://deltaloyalty-demo.my.site.com/ESWAgentWebDeployment1749608334404/assets/js/bootstrap.min.js';
      script.onload = initEmbeddedMessaging;
      script.onerror = () => {
        console.error('‚ùå Failed to load embedded messaging script');
      };
      document.head.appendChild(script);
    }
    
    // Initialize in proper sequence: Data Cloud SDK first, then embedded messaging
    async function initializeSDKSequence() {
      try {
        await loadDataCloudSDK();
        await checkForSalesforceInteractions();
        loadEmbeddedMessagingScript();
      } catch (error) {
        console.error('‚ùå Error in SDK initialization sequence:', error);
        // Fallback: still try to load embedded messaging
        loadEmbeddedMessagingScript();
      }
    }
    
    // Add network request monitoring to debug device ID usage
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      const [url, options] = args;
      if (url && (url.includes('agentforce') || url.includes('prechat') || url.includes('conversation') || url.includes('embedded') || url.includes('salesforce'))) {
        console.log('üåê Network request intercepted:', {
          url: url,
          method: options?.method || 'GET',
          body: options?.body,
          headers: options?.headers
        });
        
        // Check for problematic device ID in request body
        if (options?.body) {
          const bodyStr = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);
          if (bodyStr.includes('0PAao000006NG73GAG')) {
            console.log('üö® FOUND PROBLEMATIC DEVICE ID IN REQUEST BODY!', bodyStr);
          }
        }
      }
      
      // Return original fetch and monitor response
      const promise = originalFetch.apply(this, args);
      
      // Monitor response for problematic device ID
      if (url && (url.includes('agentforce') || url.includes('prechat') || url.includes('conversation') || url.includes('embedded') || url.includes('salesforce'))) {
        promise.then(response => {
          if (response.clone) {
            response.clone().text().then(responseText => {
              if (responseText.includes('0PAao000006NG73GAG')) {
                console.log('üö® FOUND PROBLEMATIC DEVICE ID IN RESPONSE!', {
                  url: url,
                  responseText: responseText.substring(0, 1000) + (responseText.length > 1000 ? '...' : '')
                });
              }
            }).catch(() => {
              // Ignore response reading errors
            });
          }
        }).catch(() => {
          // Ignore fetch errors
        });
      }
      
      return promise;
    };
    
    // Start the initialization sequence
    initializeSDKSequence();
  </script>
    <div id="root"></div>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
</html>
